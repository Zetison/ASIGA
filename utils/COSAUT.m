function COSAUT(COSRES,NORD,NL,NU,R,FUNCT,RERR,AERR,NPCS,NEW,IERR)
%
% PERFORMS AUTOMATIC CALCULATION OF COSINE (OR SINE) TRANSFORM TO
% SPECIFIED RELATIVE AND ABSOLUTE ERROR

% ARGUMENT LIST:

% COSRES-DOUBLE COMPLEX RESULT RETURNED BY COSAUT
% NORD-0 FOR COSINE TRANSFORM, 1 FOR SINE TRANSFORM
% NL-LOWER LIMIT FOR GAUSS ORDER TO START COMPUTATION
% NU-UPPER LIMIT FOR GAUSS ORDER
%    NU,NL=1,...7 SELECTS 3,7,15,31,63,127,AND 255 POINT GAUSS
%    QUADRATURE BETWEEN THE ZERO CROSSINGS OF THE SINUSOID
% R-ARGUMENT OF THE SINUSOID
% FUNCT-EXTERNAL FUNCTION TO EVALUATE KERNEL AT A GIVEN WAVENUMBER.  
%       THE CALL IS OF THE FORM
%           RESULT=FUNCT(X)
%       WHERE X IS SUPPLED BY COSQUD. ALL OTHER ARGUMENTS TO
%       FUNCT MUST BE PASSED IN COMMON. FUNCT MUST BE DECLARED DOUBLE
%       COMPLEX AND EXTERNAL.
% RERR,AERR-RELATIVE AND ABSOLUTE ERROR FOR TERMINATION
%      COSAUT TERMINATES WHEN INCREASING THE GAUSS ORDER DOES NOT 
%      CHANGE THE RESULT BY MORE THAN RERR OR WHEN THE ABSOLUTE ERROR
%      IS LESS THAN AERR OR WHEN A GAUSS ORDER OF NU IS REACHED.
% NPCS-NUMBER OF PIECES INTO WHICH EACH PARTIAL INTEGRAND IS DIVIDED,
%      ORDINARILY SET TO ONE. FOR VERY SMALL VALUES OF R WHERE
%      THE KERNEL FUNCTION IS APPRECIABLE ONLY OVER THE FIRST FEW
%      LOOPS OF THE SINUSOID, NPCS MAY BE INCREASED TO ACHIEVE
%      REASONABLE ACCURACY.
% NEW  IF NEW=1, THE INTEGRANDS ARE COMPUTED AND SAVED AT EACH GAUSS
%      ORDER. IF NEW=2, PREVIOUSLY COMPUTED INTEGRANDS ARE USED. NOTE
%      THAT NORD,R, AND NPCS MUST NOT BE CHANGED WHEN SETTING NEW=2.
% IERR-ERROR PARAMETER
%      IERR=0--NORMAL RETURN
%      IERR=1--RESULT NOT ACCURATE TO RERR DUE TO TOO LOW A GAUSS
%      ORDER OR CONVERGENCE NOT ACHIEVED IN COSTRN
C
% SUBROUTINES REQUIRED:
%   COSTRN,COSQUD,ZPADE
C
% A.CHAVE IGPP/UCSD

      DIMENSION TN(2),TO(2)
      EQUIVALENCE (TN(1),RESULT),(TO(1),OLD)
% COMMON /TEST/ CONTAINS RUN STATISTICS
% NG=HIGHEST GAUSS ORDER USED
% NF=TOTAL FUNCTION EVALUATIONS FOR ALL CALLS TO COSTRN
% NI=TOTAL NUMBER OF PARTIAL INTEGRANDS ON LAST CALL 
% TO COSTRN ONLY
      COMMON /TEST/NG,NF,NI
      EXTERNAL FUNCT
      NF=0
      NW=MAX(NEW,1)
      CALL COSTRN(RESULT,NORD,NL,R,FUNCT,.1*RERR,.1*AERR,
     $            NPCS,XSUM,0,NW,IERR)
      IF((IERR.NE.0).AND.(NL.EQ.7))THEN
      	COSRES=RESULT
      	NG=NL
      	RETURN
      ELSE
        OLD=RESULT
      	DO 10 N=NL+1,NU
      	  CALL COSTRN(RESULT,NORD,N,R,FUNCT,.1*RERR,.1*AERR,
     $                 NPCS,XSUM,0,2,IERR)
	  IF((IERR.NE.0).AND.(N.EQ.7))THEN
      	    COSRES=RESULT
      	    NG=N
       	    RETURN
      	  ELSEIF((ABS(TN(1)-TO(1)).LE.RERR*ABS(TN(1))+AERR).AND.
     $           (ABS(TN(2)-TO(2)).LE.RERR*ABS(TN(2))+AERR))THEN
      	    COSRES=RESULT
      	    NG=N
      	    RETURN
      	  ENDIF
   10 	  OLD=RESULT
      ENDIF
      NG=7
      IERR=1
      COSRES=RESULT
      RETURN
end

function COSTRN(RESULT,NORD,NG,R,FUNCT,RERR,AERR,NPCS, EXSUM,NSUM,NEW,IERR)

% COMPUTES COSINE (OR SINE) TRANSFORM OF SPECIFIED ORDER DEFINED AS
% INTEGRAL(FUNCT(X)*COS[SIN](X*R)) FROM X=0 TO INFINITY
% COMPUTATION IS ACHIEVED BY INTEGRATION BETWEEN THE ASYMPTOTIC
% ZERO CROSSINGS OF THE SINUSOID USING GAUSS QUADRATURE.
% THE RESULTING SERIES OF PARTIAL INTEGRANDS IS SUMMED BY CALCULATING
% THE PADE APPROXIMANTS TO SPEED UP CONVERGENCE.

% ARGUMENT LIST:

% RESULT DOUBLE COMPLEX RESULT RETURNED BY COSTRN
% NORD  0 FOR COSINE TRANSFORM, 1 FOR SINE TRANSFORM
% NG  NUMBER OF GAUSS POINTS TO USE IN THE QUADRATURE ROUTINE.
%         NG=1 THROUGH 7 SELECTS 3,7,15,31,63,126,AND 255 TERMS.
% R     ARGUMENT OF THE SINUSOID
% FUNCT   EXTERNAL FUNCTION TO EVALUATE KERNEL FUNCTION AT ARGUMENT
%         X. THE CALL IS OF THE FORM
%            RESULT=FUNCT(X)
%         ALL OTHER ARGUMENTS TO FUNCT ARE PASSED IN COMMON.
% RERR,AERR  SPECIFIED RELATIVE AND ABSOLUTE ERROR FOR THE 
%         CALCULATION.  THE INTEGRATION
%         TERMINATES WHEN AN ADDITIONAL TERM DOES NOT CHANGE THE
%         RESULT BY MORE THAN RERR*RESULT+AERR
% NPCS  NUMBER OF PIECES INTO WHICH EACH PARTIAL INTEGRAND IS DIVIDED,
%       ORDINARILY SET TO ONE. FOR VERY SMALL VALUES OF RANGE WHERE
%       THE KERNEL FUNCTION IS APPRECIABLE ONLY OVER THE FIRST FEW
%       LOOPS OF THE SINUSOID, NPCS MAY BE INCREASED TO ACHIEVE
%       REASONABLE ACCURACY. NOTE THAT NPCS AFFECTS ONLY THE PADE
%       SUM PORTION OF THE INTEGRATION, OVER X(NSUM) TO INFINITY.
% EXSUM VECTOR OF VALUES OF THE KERNEL ARGUMENT OF FUNCT FOR WHICH
%       EXPLICIT CALCULATION OF THE INTEGRAL IS DESIRED, SO THAT THE
%       INTEGRAL OVER 0 TO EXSUM(NSUM) IS ADDED TO THE INTEGRAL OVER
%       EXSUM(NSUM) TO INFINITY WITH THE PADE METHOD INVOKED ONLY FOR
%       THE LATTER. THIS ALLOWS THE PADE SUMMATION METHOD TO BE
%       OVERRIDDEN AND SOME TYPES OF SINGULARITIES TO BE HANDLED.
% NSUM  NUMBER OF VALUES IN EXSUM, MAY BE ZERO.
% NEW   DETERMINES METHOD OF KERNEL CALCULATION
%       NEW=0 MEANS  CALCULATE BUT DO NOT SAVE INTEGRANDS
%	 NEW=1 MEANS CALCULATE KERNEL BY CALLING FUNCT-SAVE KERNEL
%             TIMES SINUSOID
%	 NEW=2 MEANS USE SAVED KERNELS TIMES SINUSOIDS IN
%	       COMMON /COSINT/. NOTE THAT R,NPCS,EXSUM, AND
%             NSUM MAY NOT BE CHANGED WHEN SETTING NEW=2.
% IERR  ERROR PARAMETER
%       0 NORMAL RETURN-INTEGRAL CONVERGED
%       1 MEANS NO CONVERGENCE AFTER NSTOP TERMS IN THE PADE SUM

% SUBROUTINES REQUIRED:
% COSQUD,ZPADE,ZERO

% A.CHAVE IGPP/UCSD

% NTERM IS MAXIMUM NUMBER OF SINUSOID LOOPS STORED IF NEW.NE.0
% NSTOP IS MAXIMUM NUMBER OF PADE TERMS

      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      PARAMETER (NTERM=200, NSTOP=100)
      PARAMETER (PI=3.141592653589793D0)
      DOUBLE COMPLEX RESULT,KERN,LAST,SUM,XSUM,TERM,S,T,FUNCT
      DOUBLE PRECISION KARG
      DIMENSION EXSUM(1),KARG(255,NTERM),KERN(255,NTERM),S(NSTOP),
     $          NK(NTERM),TO(2),TN(2),TX(2)
      EQUIVALENCE (TO(1),LAST),(TN(1),SUM),(TX(1),XSUM)
% COMMON /TEST/ CONTAINS RUN STATISTICS
% NGAUSS=HIGHEST GAUSS ORDER USED
% NF=TOTAL FUNCTION EVALUATIONS FOR ALL CALLS TO COSTRN 
% NI=TOTAL NUMBER OF PARTIAL INTEGRANDS USED IN PADECF ON LAST CALL 
% TO COSTRN
      COMMON /TEST/NGAUSS,NF,NI
% IF NEW.GT.0, COMMON /COSINT/ CONTAINS THE KERNEL FUNCTION ARGUMENTS 
% AND VALUES KARG(I,N),KERN(I,N) FOR N=1 TO NPS AND I=1 TO
% 2**(NK(N)+1)-1.
% KERN(I,N) CONTAINS THE COMPLEX
% KERNEL FUNCTION FOR THE CORRESPONDING ARGUMENT VALUE KARG(I,N).
% EACH VALUE OF N CORRESPONDS TO ONE ENTRY IN EXSUM OR TO ONE INTERVAL
% BETWEEN ZERO CROSSINGS OF THE SINUSOID DIVIDED BY NPCS.
% NOTE THAT UP TO NTERM VALUES ARE STORED. THE INTEGRATION PROCEEDS
% FOR N.GT.NTERM AS IF NEW=0. NP IS AN INDEX PASSED INTERNALLY BY
% COSTRN.
      COMMON /COSINT/NK,NP,NPS,KARG,KERN
      EXTERNAL FUNCT
      IF(NEW.EQ.2)THEN
      	NPO=NPS
      ELSE
      	DO 5 I=1,NTERM
    5 	  NK(I)=0
      	NPS=0
      	NPO=NTERM
      ENDIF
      NI=0
      NW=NEW
      NP=1
      NPB=1
      L=1
      B=0.0
      SUM=DCMPLX(0.,0.)
      XSUM=DCMPLX(0.,0.)
      IF(NSUM.GT.0)THEN
% COMPUTE TRANSFORM EXPLICITLY ON (0,EXSUM(NSUM))
        LAST=DCMPLX(0.,0.)
      	DO 10 N=1,NSUM
          IF((NW.EQ.2).AND.(NP.GT.NPO))NW=1
      	  IF(NP.GT.NTERM)NW=0
       	  A=B
      	  B=EXSUM(N)
      	  CALL COSQUD(A,B,TERM,NG,NW,NORD,R,FUNCT)
      	  XSUM=XSUM+TERM
      	  IF((ABS(TX(1)-TO(1)).LE.RERR*ABS(TX(1))+AERR).AND.
     $      (ABS(TX(2)-TO(2)).LE.RERR*ABS(TX(2))+AERR))THEN
      	    RESULT=XSUM
      	    IERR=0
      	    NPS=MAX(NP,NPS)
      	    RETURN
      	  ENDIF
      	  NP=NP+1
   10     LAST=XSUM
% FIND FIRST ZERO CROSSING OF SINUSOID BEYOND EXSUM(NSUM)
   15   CONTINUE
      	IF(NPB*PI/(2.*ABS(R)).GT.EXSUM(NSUM))GOTO 20
      	NPB=NPB+1
      	GOTO 15
      ENDIF
% ENTRY POINT FOR PADE SUMMATION OF PARTIAL INTEGRANDS
   20 CONTINUE
      LAST=DCMPLX(0.,0.)
      A=B
      B=NPB*PI/(2.*ABS(R))
% CALCULATE TERMS AND SUM WITH ZPADE, QUITTING WHEN CONVERGENCE IS
% OBTAINED
      DO 30 N=1,NSTOP
      	IF(NPCS.EQ.1)THEN
      	  IF((NW.EQ.2).AND.(NP.GT.NPO))NW=1
       	  IF(NP.GT.NTERM)NW=0
          CALL COSQUD(A,B,TERM,NG,NW,NORD,R,FUNCT)
      	  NP=NP+1
      	ELSE
      	  TERM=DCMPLX(0.,0.)
      	  XINC=(B-A)/NPCS
      	  AA=A
      	  BB=A+XINC
      	  DO 25 I=1,NPCS
      	    IF((NW.EQ.2).AND.(NP.GT.NPO))NW=1
       	    IF(NP.GT.NTERM)NW=0
      	    CALL COSQUD(AA,BB,T,NG,NW,NORD,R,FUNCT)
      	    TERM=TERM+T
      	    AA=BB
      	    BB=BB+XINC
   25       NP=NP+1
        ENDIF
      	NI=NI+1
        S(L)=TERM
        CALL ZPADE(SUM,S,L)
        IF((ABS(TN(1)-TO(1)).LE.RERR*ABS(TN(1))+AERR).AND.
     $     (ABS(TN(2)-TO(2)).LE.RERR*ABS(TN(2))+AERR))THEN
      	  RESULT=XSUM+SUM
      	  IERR=0
      	  NPS=MAX(NP-1,NPS)
          RETURN
        ENDIF
        LAST=SUM
      	NPB=NPB+1
        A=B
        B=NPB*PI/(2.*ABS(R))
   30   L=L+1
      RESULT=XSUM+SUM
      IERR=1
      NPS=MAX(NP,NPS)
      RETURN
      END
end
function COSQUD(A,B,RESULT,NG,NEW,NORD,R,F)

% THIS SUBROUTINE CALCULATES THE INTEGRAL OF F(X)*COS[SIN](X*R) 
% OVER THE INTERVAL A TO B AT A SPECIFIED GAUSS ORDER
% THE RESULT IS OBTAINED USING A SEQUENCE OF 1,3,7,15,31,63,
% 127, AND 255 POINT INTERLACING GAUSS FORMULAE SO THAT NO INTEGRAND
% EVALUATIONS ARE WASTED. THE KERNEL FUNCTIONS MAY BE SAVED SO THAT
% TRANSFORMS OF SIMILAR KERNELS ARE COMPUTED WITHOUT NEW
% EVALUATION OF THE KERNEL.
% DETAILS ON THE FORMULAE ARE GIVEN IN 'THE OPTIMUM ADDITION OF POINTS
% TO QUADRATURE FORMULAE' BY T.N.L. PATTERSON, MATHS.COMP.
% 22,847-856 (1968). GAUSS WEIGHTS TAKEN FROM 
% COMM. A.C.M. 16,694-699 (1973)
C
C ARGUMENT LIST:
C
C A      LOWER LIMIT OF INTEGRATION
C B      UPPER LIMIT OF INTEGRATION
C RESULT RETURNED COMPLEX INTEGRAL VALUE
C NG NUMBER OF POINTS IN THE GAUSS FORMULA.  NG=1,...7
%       SELECTS 3,7,15,31,63,127,AND 255 POINT QUADRATURE.
C NEW SELECTS METHOD OF KERNEL EVALUATION
%    NEW=0 CALCULATES KERNELS BY CALLING F - NOTHING SAVED
%    NEW=1 CALCULATES KERNELS BY CALLING F AND SAVES KERNEL TIMES
%           SINUSOID IN COMMON /COSINT/
%    NEW=2 USES SAVED KERNEL TIMES SINUSOIDS IN
%          COMMON /COSINT/
C NORD 0 FOR COSINE AND 1 FOR SINE TRANSFORM
C R    ARGUMENT OF THE SINUSOID
C F      F(X) IS THE EXTERNAL INTEGRAND FUNCTION
C
% A.CHAVE IGPP/UCSD 
C
% MAXIMUM NUMBER OF SINUSOID LOOPS THAT CAN BE SAVED
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      PARAMETER (NTERM=200)
      DOUBLE COMPLEX RESULT,KERN,FZERO,F1,F2,FUNCT,F
      DOUBLE PRECISION KARG
      DIMENSION WT(254),WA(127),NWA(7),NWT(7),KARG(255,NTERM),
     $          KERN(255,NTERM),FUNCT(254),F1(128),F2(128),
     $          COS1(64),COS2(64),NK(NTERM),RFUNCT(508)
      EQUIVALENCE (FUNCT,RFUNCT)
% COMMON /TEST/ CONTAINS RUN STATISTICS
% NGAUSS=HIGHEST GAUSS ORDER USED
% NF=TOTAL FUNCTION EVALUATIONS  FOR ALL CALLS TO COSTRN 
% NI=TOTAL NUMBER OF PARTIAL INTEGRANDS ON LAST CALL 
% TO COSTRN ONLY
      COMMON /TEST/NGAUSS,NF,NI
      COMMON /COSINT/NK,NP,NPS,KARG,KERN
      EXTERNAL F
% STARTING ADDRESSES IN ARRAYS WT AND WA AT EACH ORDER
      DATA NWT/1,3,7,15,31,63,127/,NWA/1,2,4,8,16,32,64/
% ARRAY WT CONTAINS GAUSS QUADRATURE WEIGHTS STORED AS NEEDED AT
% EACH ORDER.  ARRAY WA CONTAINS THE CORRESPONDING ARGUMENT WEIGHTS.
      DATA (WT(I),I=1,20)/
     $0.55555555555555555556D+00,0.88888888888888888889D+00,
     $0.26848808986833344073D+00,0.10465622602646726519D+00,
     $0.40139741477596222291D+00,0.45091653865847414235D+00,
     $0.13441525524378422036D+00,0.51603282997079739697D-01,
     $0.20062852937698902103D+00,0.17001719629940260339D-01,
     $0.92927195315124537686D-01,0.17151190913639138079D+00,
     $0.21915685840158749640D+00,0.22551049979820668739D+00,
     $0.67207754295990703540D-01,0.25807598096176653565D-01,
     $0.10031427861179557877D+00,0.84345657393211062463D-02,
     $0.46462893261757986541D-01,0.85755920049990351154D-01/
      DATA (WT(I),I=21,40)/
     $0.10957842105592463824D+00,0.25447807915618744154D-02,
     $0.16446049854387810934D-01,0.35957103307129322097D-01,
     $0.56979509494123357412D-01,0.76879620499003531043D-01,
     $0.93627109981264473617D-01,0.10566989358023480974D+00,
     $0.11195687302095345688D+00,0.11275525672076869161D+00,
     $0.33603877148207730542D-01,0.12903800100351265626D-01,
     $0.50157139305899537414D-01,0.42176304415588548391D-02,
     $0.23231446639910269443D-01,0.42877960025007734493D-01,
     $0.54789210527962865032D-01,0.12651565562300680114D-02,
     $0.82230079572359296693D-02,0.17978551568128270333D-01/
      DATA (WT(I),I=41,60)/
     $0.28489754745833548613D-01,0.38439810249455532039D-01,
     $0.46813554990628012403D-01,0.52834946790116519862D-01,
     $0.55978436510476319408D-01,0.36322148184553065969D-03,
     $0.25790497946856882724D-02,0.61155068221172463397D-02,
     $0.10498246909621321898D-01,0.15406750466559497802D-01,
     $0.20594233915912711149D-01,0.25869679327214746911D-01,
     $0.31073551111687964880D-01,0.36064432780782572640D-01,
     $0.40715510116944318934D-01,0.44914531653632197414D-01,
     $0.48564330406673198716D-01,0.51583253952048458777D-01,
     $0.53905499335266063927D-01,0.55481404356559363988D-01/
      DATA (WT(I),I=61,80)/
     $0.56277699831254301273D-01,0.56377628360384717388D-01,
     $0.16801938574103865271D-01,0.64519000501757369228D-02,
     $0.25078569652949768707D-01,0.21088152457266328793D-02,
     $0.11615723319955134727D-01,0.21438980012503867246D-01,
     $0.27394605263981432516D-01,0.63260731936263354422D-03,
     $0.41115039786546930472D-02,0.89892757840641357233D-02,
     $0.14244877372916774306D-01,0.19219905124727766019D-01,
     $0.23406777495314006201D-01,0.26417473395058259931D-01,
     $0.27989218255238159704D-01,0.18073956444538835782D-03,
     $0.12895240826104173921D-02,0.30577534101755311361D-02/
      DATA (WT(I),I=81,100)/
     $0.52491234548088591251D-02,0.77033752332797418482D-02,
     $0.10297116957956355524D-01,0.12934839663607373455D-01,
     $0.15536775555843982440D-01,0.18032216390391286320D-01,
     $0.20357755058472159467D-01,0.22457265826816098707D-01,
     $0.24282165203336599358D-01,0.25791626976024229388D-01,
     $0.26952749667633031963D-01,0.27740702178279681994D-01,
     $0.28138849915627150636D-01,0.50536095207862517625D-04,
     $0.37774664632698466027D-03,0.93836984854238150079D-03,
     $0.16811428654214699063D-02,0.25687649437940203731D-02,
     $0.35728927835172996494D-02,0.46710503721143217474D-02/
      DATA (WT(I),I=101,120)/
     $0.58434498758356395076D-02,0.70724899954335554680D-02,
     $0.83428387539681577056D-02,0.96411777297025366953D-02,
     $0.10955733387837901648D-01,0.12275830560082770087D-01,
     $0.13591571009765546790D-01,0.14893641664815182035D-01,
     $0.16173218729577719942D-01,0.17421930159464173747D-01,
     $0.18631848256138790186D-01,0.19795495048097499488D-01,
     $0.20905851445812023852D-01,0.21956366305317824939D-01,
     $0.22940964229387748761D-01,0.23854052106038540080D-01,
     $0.24690524744487676909D-01,0.25445769965464765813D-01,
     $0.26115673376706097680D-01,0.26696622927450359906D-01/
      DATA (WT(I),I=121,140)/
     $0.27185513229624791819D-01,0.27579749566481873035D-01,
     $0.27877251476613701609D-01,0.28076455793817246607D-01,
     $0.28176319033016602131D-01,0.28188814180192358694D-01,
     $0.84009692870519326354D-02,0.32259500250878684614D-02,
     $0.12539284826474884353D-01,0.10544076228633167722D-02,
     $0.58078616599775673635D-02,0.10719490006251933623D-01,
     $0.13697302631990716258D-01,0.31630366082226447689D-03,
     $0.20557519893273465236D-02,0.44946378920320678616D-02,
     $0.71224386864583871532D-02,0.96099525623638830097D-02,
     $0.11703388747657003101D-01,0.13208736697529129966D-01/
      DATA (WT(I),I=141,160)/
     $0.13994609127619079852D-01,0.90372734658751149261D-04,
     $0.64476204130572477933D-03,0.15288767050877655684D-02,
     $0.26245617274044295626D-02,0.38516876166398709241D-02,
     $0.51485584789781777618D-02,0.64674198318036867274D-02,
     $0.77683877779219912200D-02,0.90161081951956431600D-02,
     $0.10178877529236079733D-01,0.11228632913408049354D-01,
     $0.12141082601668299679D-01,0.12895813488012114694D-01,
     $0.13476374833816515982D-01,0.13870351089139840997D-01,
     $0.14069424957813575318D-01,0.25157870384280661489D-04,
     $0.18887326450650491366D-03,0.46918492424785040975D-03/
      DATA (WT(I),I=161,180)/
     $0.84057143271072246365D-03,0.12843824718970101768D-02,
     $0.17864463917586498247D-02,0.23355251860571608737D-02,
     $0.29217249379178197538D-02,0.35362449977167777340D-02,
     $0.41714193769840788528D-02,0.48205888648512683476D-02,
     $0.54778666939189508240D-02,0.61379152800413850435D-02,
     $0.67957855048827733948D-02,0.74468208324075910174D-02,
     $0.80866093647888599710D-02,0.87109650797320868736D-02,
     $0.93159241280693950932D-02,0.98977475240487497440D-02,
     $0.10452925722906011926D-01,0.10978183152658912470D-01,
     $0.11470482114693874380D-01,0.11927026053019270040D-01/
      DATA (WT(I),I=181,200)/
     $0.12345262372243838455D-01,0.12722884982732382906D-01,
     $0.13057836688353048840D-01,0.13348311463725179953D-01,
     $0.13592756614812395910D-01,0.13789874783240936517D-01,
     $0.13938625738306850804D-01,0.14038227896908623303D-01,
     $0.14088159516508301065D-01,0.69379364324108267170D-05,
     $0.53275293669780613125D-04,0.13575491094922871973D-03,
     $0.24921240048299729402D-03,0.38974528447328229322D-03,
     $0.55429531493037471492D-03,0.74028280424450333046D-03,
     $0.94536151685852538246D-03,0.11674841174299594077D-02,
     $0.14049079956551446427D-02,0.16561127281544526052D-02/
      DATA (WT(I),I=201,220)/
     $0.19197129710138724125D-02,0.21944069253638388388D-02,
     $0.24789582266575679307D-02,0.27721957645934509940D-02,
     $0.30730184347025783234D-02,0.33803979910869203823D-02,
     $0.36933779170256508183D-02,0.40110687240750233989D-02,
     $0.43326409680929828545D-02,0.46573172997568547773D-02,
     $0.49843645647655386012D-02,0.53130866051870565663D-02,
     $0.56428181013844441585D-02,0.59729195655081658049D-02,
     $0.63027734490857587172D-02,0.66317812429018878941D-02,
     $0.69593614093904229394D-02,0.72849479805538070639D-02,
     $0.76079896657190565832D-02,0.79279493342948491103D-02/
      DATA (WT(I),I=221,240)/
     $0.82443037630328680306D-02,0.85565435613076896192D-02,
     $0.88641732094824942641D-02,0.91667111635607884067D-02,
     $0.94636899938300652943D-02,0.97546565363174114611D-02,
     $0.10039172044056840798D-01,0.10316812330947621682D-01,
     $0.10587167904885197931D-01,0.10849844089337314099D-01,
     $0.11104461134006926537D-01,0.11350654315980596602D-01,
     $0.11588074033043952568D-01,0.11816385890830235763D-01,
     $0.12035270785279562630D-01,0.12244424981611985899D-01,
     $0.12443560190714035263D-01,0.12632403643542078765D-01,
     $0.12810698163877361967D-01,0.12978202239537399286D-01/
      DATA (WT(I),I=241,254)/
     $0.13134690091960152836D-01,0.13279951743930530650D-01,
     $0.13413793085110098513D-01,0.13536035934956213614D-01,
     $0.13646518102571291428D-01,0.13745093443001896632D-01,
     $0.13831631909506428676D-01,0.13906019601325461264D-01,
     $0.13968158806516938516D-01,0.14017968039456608810D-01,
     $0.14055382072649964277D-01,0.14080351962553661325D-01,
     $0.14092845069160408355D-01,0.14094407090096179347D-01/
      DATA (WA(I),I=1,20)/
     $0.77459666924148337704D+00,0.96049126870802028342D+00,
     $0.43424374934680255800D+00,0.99383196321275502221D+00,
     $0.88845923287225699889D+00,0.62110294673722640294D+00,
     $0.22338668642896688163D+00,0.99909812496766759766D+00,
     $0.98153114955374010687D+00,0.92965485742974005667D+00,
     $0.83672593816886873550D+00,0.70249620649152707861D+00,
     $0.53131974364437562397D+00,0.33113539325797683309D+00,
     $0.11248894313318662575D+00,0.99987288812035761194D+00,
     $0.99720625937222195908D+00,0.98868475754742947994D+00,
     $0.97218287474858179658D+00,0.94634285837340290515D+00/
      DATA (WA(I),I=21,40)/
     $0.91037115695700429250D+00,0.86390793819369047715D+00,
     $0.80694053195021761186D+00,0.73975604435269475868D+00,
     $0.66290966002478059546D+00,0.57719571005204581484D+00,
     $0.48361802694584102756D+00,0.38335932419873034692D+00,
     $0.27774982202182431507D+00,0.16823525155220746498D+00,
     $0.56344313046592789972D-01,0.99998243035489159858D+00,
     $0.99959879967191068325D+00,0.99831663531840739253D+00,
     $0.99572410469840718851D+00,0.99149572117810613240D+00,
     $0.98537149959852037111D+00,0.97714151463970571416D+00,
     $0.96663785155841656709D+00,0.95373000642576113641D+00/
      DATA (WA(I),I=41,60)/
     $0.93832039777959288365D+00,0.92034002547001242073D+00,
     $0.89974489977694003664D+00,0.87651341448470526974D+00,
     $0.85064449476835027976D+00,0.82215625436498040737D+00,
     $0.79108493379984836143D+00,0.75748396638051363793D+00,
     $0.72142308537009891548D+00,0.68298743109107922809D+00,
     $0.64227664250975951377D+00,0.59940393024224289297D+00,
     $0.55449513263193254887D+00,0.50768775753371660215D+00,
     $0.45913001198983233287D+00,0.40897982122988867241D+00,
     $0.35740383783153215238D+00,0.30457644155671404334D+00,
     $0.25067873030348317661D+00,0.19589750271110015392D+00/
      DATA (WA(I),I=61,80)/
     $0.14042423315256017459D+00,0.84454040083710883710D-01,
     $0.28184648949745694339D-01,0.99999759637974846462D+00,
     $0.99994399620705437576D+00,0.99976049092443204733D+00,
     $0.99938033802502358193D+00,0.99874561446809511470D+00,
     $0.99780535449595727456D+00,0.99651414591489027385D+00,
     $0.99483150280062100052D+00,0.99272134428278861533D+00,
     $0.99015137040077015918D+00,0.98709252795403406719D+00,
     $0.98351865757863272876D+00,0.97940628167086268381D+00,
     $0.97473445975240266776D+00,0.96948465950245923177D+00,
     $0.96364062156981213252D+00,0.95718821610986096274D+00/
      DATA (WA(I),I=81,100)/
     $0.95011529752129487656D+00,0.94241156519108305981D+00,
     $0.93406843615772578800D+00,0.92507893290707565236D+00,
     $0.91543758715576504064D+00,0.90514035881326159519D+00,
     $0.89418456833555902286D+00,0.88256884024734190684D+00,
     $0.87029305554811390585D+00,0.85735831088623215653D+00,
     $0.84376688267270860104D+00,0.82952219463740140018D+00,
     $0.81462878765513741344D+00,0.79909229096084140180D+00,
     $0.78291939411828301639D+00,0.76611781930376009072D+00,
     $0.74869629361693660282D+00,0.73066452124218126133D+00,
     $0.71203315536225203459D+00,0.69281376977911470289D+00/
      DATA (WA(I),I=101,120)/
     $0.67301883023041847920D+00,0.65266166541001749610D+00,
     $0.63175643771119423041D+00,0.61031811371518640016D+00,
     $0.58836243444766254143D+00,0.56590588542365442262D+00,
     $0.54296566649831149049D+00,0.51955966153745702199D+00,
     $0.49570640791876146017D+00,0.47142506587165887693D+00,
     $0.44673538766202847374D+00,0.42165768662616330006D+00,
     $0.39621280605761593918D+00,0.37042208795007823014D+00,
     $0.34430734159943802278D+00,0.31789081206847668318D+00,
     $0.29119514851824668196D+00,0.26424337241092676194D+00,
     $0.23705884558982972721D+00,0.20966523824318119477D+00/
      DATA (WA(I),I=121,127)/
     $0.18208649675925219825D+00,0.15434681148137810869D+00,
     $0.12647058437230196685D+00,0.98482396598119202090D-01,
     $0.70406976042855179063D-01,0.42269164765363603212D-01,
     $0.14093886410782462614D-01/
% SCALE FACTORS
      SUM=(B+A)/2.
      DIFF=(B-A)/2.
      IF(NEW.EQ.2)GOTO 200
% ONE POINT GAUSS
      FZERO=F(SUM)
      NF=NF+1
      IF(NEW.EQ.1)THEN
      	KARG(1,NP)=SUM
      	KERN(1,NP)=FZERO
      	LA=2
      	LK=2
      ENDIF
      IF(NORD.EQ.0)THEN
        COSF=COS(SUM*R)
      ELSE
      	COSF=SIN(SUM*R)
      ENDIF
      FZERO=COSF*FZERO
      N=1
      KN=1
    5 CONTINUE
% STEP THROUGH GAUSS ORDERS
      DO 40 K=KN,NG
% COMPUTE NEW FUNCTION VALUES
      	NA=NWA(K)
      	DO 10 J=1,NWA(K)
      	  X=WA(NA)*DIFF
      	  NA=NA+1
      	  SUMP=SUM+X
      	  SUMM=SUM-X
      	  IF(NEW.GE.1)THEN
      	    KARG(LA,NP)=SUMP
      	    KARG(LA+1,NP)=SUMM
      	    LA=LA+2
      	  ENDIF
      	  F1(J)=F(SUMP)
          F2(J)=F(SUMM)
      	  NF=NF+2
      	  IF(NORD.EQ.0)THEN
      	    COS1(J)=COS(SUMP*R)
      	    COS2(J)=COS(SUMM*R)
      	  ELSE
      	    COS1(J)=SIN(SUMP*R)
      	    COS2(J)=SIN(SUMM*R)
      	  ENDIF
   10   CONTINUE
      	IF(NEW.GE.1)THEN
      	  DO 20 J=1,NWA(K)
      	    KERN(LK,NP)=F1(J)
	    KERN(LK+1,NP)=F2(J)
   20 	    LK=LK+2
      	ENDIF
% COMPUTE PRODUCTS OF KERNELS AND SINUSOIDS
      	DO 30 J=1,NWA(K)
      	  F1(J)=COS1(J)*F1(J)
      	  F2(J)=COS2(J)*F2(J)
      	  FUNCT(N)=F1(J)+F2(J)
   30 	  N=N+1
   40 CONTINUE
% COMPUTE DOT PRODUCT OF WEIGHTS WITH INTEGRAND VALUES
      NW=NWT(NG)
      ACUMR=0.
      ACUMI=0.
      II=1
      DO 50 I=1,NW
      	ACUMR=ACUMR+WT(NW+I-1)*RFUNCT(II)
        ACUMI=ACUMI+WT(NW+I-1)*RFUNCT(II+1)
   50   II=II+2
      RESULT=(DCMPLX(ACUMR,ACUMI)+WT(2*NW)*FZERO)*DIFF
      IF(NP.LE.NTERM)NK(NP)=NG
      RETURN
  200 CONTINUE
% CONSTRUCT FUNCT FROM SAVED KERNELS
      IF(NORD.EQ.0)THEN
        FZERO=KERN(1,NP)*COS(KARG(1,NP)*R)
      ELSE
      	FZERO=KERN(1,NP)*SIN(KARG(1,NP)*R)
      ENDIF
      K=MIN(NK(NP),NG)
      NW=NWT(K)
      LK=2
      IF(NORD.EQ.0)THEN
        DO 210 N=1,NW
      	  F1(N)=KERN(LK,NP)*COS(KARG(LK,NP)*R)
          F2(N)=KERN(LK+1,NP)*COS(KARG(LK+1,NP)*R)
          FUNCT(N)=F1(N)+F2(N)
          LK=LK+2
  210     CONTINUE
      ELSE
      	DO 212 N=1,NW
          F1(N)=KERN(LK,NP)*SIN(KARG(LK,NP)*R)
          F2(N)=KERN(LK+1,NP)*SIN(KARG(LK+1,NP)*R)
          FUNCT(N)=F1(N)+F2(N)
          LK=LK+2  
  212     CONTINUE
      ENDIF
      IF(NK(NP).GE.NG)THEN
% NO ADDITIONAL ORDERS REQUIRED-COMPUTE DOT PRODUCT OF WEIGHTS WITH
% INTEGRAND VALUES AND RETURN
      	ACUMR=0.
        ACUMI=0.
      	II=1
      	DO 220 I=1,NW
      	  ACUMR=ACUMR+WT(NW+I-1)*RFUNCT(II)
          ACUMI=ACUMI+WT(NW+I-1)*RFUNCT(II+1)
  220     II=II+2
      	RESULT=(DCMPLX(ACUMR,ACUMI)+WT(2*NW)*FZERO)*DIFF
      	RETURN
      ELSE
% COMPUTE ADDITIONAL ORDERS BEFORE TAKING DOT PRODUCT
      	N=NW+1
      	KN=K+1
      	LA=LK
     	GOTO 5
      ENDIF
      END
end


function ZPADE(SUM,S,N)
% CALCULATES SUM OVER I FROM 1 TO N OF S(I) BY COMPUTATION OF
% PADE APPROXIMANT USING CONTINUED FRACTION EXPANSION.
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      PARAMETER (NC=100)
      DOUBLE COMPLEX SUM,S,X,D,CFCO,T
      DIMENSION S(N),X(NC),D(0:NC),CFCO(NC),T(NC)
      SAVE X,D,CFCO
      DATA D(0)/(-1.,0.)/

      IF(N.LT.3)THEN
% INITIALIZE FOR RECURSIVE COMPUTATION
      	IF(N.EQ.1)THEN
      	  DO 10 I=1,NC
   10       X(I)=DCMPLX(0.,0.)
      	ENDIF
      	D(N)=S(N)
      	CFCO(N)=-D(N)/D(N-1)
      	IF(N.EQ.1)SUM=CFCO(1)
      	IF(N.EQ.2)SUM=CFCO(1)/(DCMPLX(1.,0.)+CFCO(2))
      	RETURN
      ELSE
      	L=2*INT((N-1)/2)
% UPDATE X VECTORS FOR RECURSIVE COMPUTATION OF CF COEFFICIENTS
      	DO 20 K=L,4,-2
   20     X(K)=X(K-1)+CFCO(N-1)*X(K-2)
      	X(2)=X(1)+CFCO(N-1)
% INTERCHANGE ODD AND EVEN PARTS
      	DO 30 K=1,MAX(1,L-1),2
      	  T(K)=X(K)
      	  X(K)=X(K+1)
   30     X(K+1)=T(K)
% COMPUTE FIRST COEFFICIENTS
      	D(N)=S(N)
      	DO 40 K=1,MAX(1,L/2)
   40     D(N)=D(N)+S(N-K)*X(2*K-1)
% COMPUTE NEW CF COEFFICIENT
      	CFCO(N)=-D(N)/D(N-1)
% EVALUATE CONTINUED FRACTION
      	SUM=DCMPLX(1.,0.)
      	DO 50 K=N,2,-1
   50     SUM=DCMPLX(1.,0.)+CFCO(K)/SUM
      	SUM=CFCO(1)/SUM
      	RETURN
      ENDIF
      END
